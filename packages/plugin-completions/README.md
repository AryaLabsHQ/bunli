# @bunli/plugin-completions

Shell completion generation plugin for Bunli CLI applications. Automatically generates completion scripts for Bash, Zsh, and Fish shells based on your command definitions.

## Features

- üêö **Multi-shell support**: Generates completions for Bash, Zsh, and Fish
- üéØ **Type-aware**: Leverages command metadata from Bunli's type generation
- üìã **Enum support**: Provides completions for enum option values
- ‚ö° **Zero configuration**: Works out of the box with your existing commands
- üîß **Customizable**: Output to file or stdout for flexible installation

## Installation

```bash
bun add @bunli/plugin-completions
```

## Usage

### 1. Add the plugin to your CLI

```typescript
import { createCLI } from '@bunli/core'
import { completionsPlugin } from '@bunli/plugin-completions'

const cli = await createCLI({
  name: 'my-cli',
  version: '1.0.0',
  plugins: [completionsPlugin()] as const
})
```

Or in your `bunli.config.ts`:

```typescript
import { defineConfig } from '@bunli/core'
import { completionsPlugin } from '@bunli/plugin-completions'

export default defineConfig({
  name: 'my-cli',
  plugins: [completionsPlugin()]
})
```

### 2. Generate completions

The plugin adds a `completions` command to your CLI:

```bash
# Output to stdout (with installation instructions)
my-cli completions --shell bash
my-cli completions --shell zsh
my-cli completions --shell fish

# Save to file
my-cli completions --shell bash --output completions.sh
my-cli completions -s zsh -o _my-cli
my-cli completions -s fish -o my-cli.fish
```

### 3. Install completions

#### Bash

**Option 1 - Current session:**
```bash
source <(my-cli completions --shell bash)
```

**Option 2 - Save to completion directory:**
```bash
my-cli completions --shell bash > /etc/bash_completion.d/my-cli
# Or on macOS with Homebrew:
my-cli completions --shell bash > $(brew --prefix)/etc/bash_completion.d/my-cli
```

**Option 3 - Add to ~/.bashrc:**
```bash
echo 'source <(my-cli completions --shell bash)' >> ~/.bashrc
source ~/.bashrc
```

#### Zsh

**Option 1 - Current session:**
```bash
source <(my-cli completions --shell zsh)
```

**Option 2 - User completion directory:**
```bash
mkdir -p ~/.zsh/completions
my-cli completions --shell zsh > ~/.zsh/completions/_my-cli

# Add to ~/.zshrc if not already present:
fpath=(~/.zsh/completions $fpath)
autoload -U compinit && compinit
```

**Option 3 - System-wide:**
```bash
sudo my-cli completions --shell zsh > /usr/local/share/zsh/site-functions/_my-cli
# Restart your shell
```

#### Fish

**User completions:**
```bash
my-cli completions --shell fish > ~/.config/fish/completions/my-cli.fish
# Completions will be available in new fish sessions
```

**System-wide:**
```bash
sudo my-cli completions --shell fish > /usr/share/fish/vendor_completions.d/my-cli.fish
```

## How It Works

The plugin leverages Bunli's command metadata generation system to create accurate completion scripts:

1. **Metadata extraction**: The plugin reads the `.bunli/commands.gen.ts` file generated by Bunli's type generation
2. **Command structure**: Parses command names, descriptions, options, and flags
3. **Type information**: Uses Zod schema metadata to extract enum values and validation rules
4. **Shell-specific syntax**: Generates appropriate completion syntax for each shell

## Command Options

### Required

- `--shell, -s <shell>`: Target shell (`bash`, `zsh`, or `fish`)

### Optional

- `--output, -o <path>`: Output file path (default: stdout)

## Example Output

Given a command like:

```typescript
import { defineCommand, option } from '@bunli/core'
import { z } from 'zod'

export default defineCommand({
  name: 'deploy',
  description: 'Deploy application',
  options: {
    environment: option(
      z.enum(['development', 'staging', 'production']),
      { short: 'e', description: 'Target environment' }
    ),
    force: option(
      z.boolean().optional(),
      { short: 'f', description: 'Force deployment' }
    )
  },
  handler: async ({ flags }) => {
    // ...
  }
})
```

The completions plugin will generate:

**Bash:**
```bash
# Provides enum completions for --environment
if [[ "$prev" == "--environment" || "$prev" == "-e" ]]; then
  COMPREPLY=($(compgen -W "development staging production" -- "$cur"))
  return
fi
```

**Zsh:**
```zsh
# Provides enum completions with descriptions
"(-e --environment)"{-e,--environment}[Target environment]:(development staging production)
"(-f --force)"{-f,--force}[Force deployment]
```

**Fish:**
```fish
# Provides enum completions with conditions
complete -c my-cli -n '__fish_seen_subcommand_from deploy' \
  -l environment -s e -d 'Target environment' -r -a 'development staging production'
complete -c my-cli -n '__fish_seen_subcommand_from deploy' \
  -l force -s f -d 'Force deployment'
```

## Plugin Options

```typescript
interface CompletionsPluginOptions {
  // Currently no configuration options
  // Reserved for future features like:
  // - Custom completion handlers
  // - Additional shell support
  // - Completion behavior customization
}
```

## Limitations

- **No subcommand completions**: Currently only supports top-level commands
- **No dynamic completions**: Completions are static based on command metadata
- **No positional argument completions**: Only flags and options are completed

## Development

```bash
# Build the plugin
bun run build

# Run tests (if available)
bun test
```

## License

MIT
